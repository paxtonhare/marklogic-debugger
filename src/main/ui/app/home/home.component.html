<mdl-layout mdl-layout-fixed-header mdl-layout-header-seamed>
  <mdl-layout-header>
    <mdl-layout-header-row>
      <mdl-layout-title>
        <span class="server">http://{{hostname}}:{{port}}</span>
      </mdl-layout-title>
      <mdl-layout-spacer></mdl-layout-spacer>
      <button mdl-button #btn2="mdlButton" (click)="m2.toggle($event, btn2)" mdl-button-type="icon" mdl-ripple><mdl-icon>more_vert</mdl-icon></button>
      <mdl-menu #m2="mdlMenu" mdl-menu-position="bottom-right">
        <mdl-menu-item mdl-ripple (click)="showWelcome()">Show Welcome Message</mdl-menu-item>
        <mdl-menu-item mdl-ripple (click)="openNewIssue()">Report an Issue</mdl-menu-item>
        <mdl-menu-item mdl-ripple (click)="logout()">Sign Out</mdl-menu-item>
      </mdl-menu>
    </mdl-layout-header-row>
  </mdl-layout-header>
  <mdl-layout-content>
    <div gm-grid>
      <div gm-row class="flex flex-70">
        <div gm-col class="flex flex-30 files">
          <div class="section-title">
            <div>
              <span *ngIf="modulesDb">Files for DB: </span>
              <button mdl-button #chooseModulesButton="mdlButton" (click)="chooseModulesMenu.toggle($event, chooseModulesButton)" mdl-ripple>
                <span>{{currentModulesDb()}}</span>
                <i class="fa fa-caret-down"></i>
              </button>
              <mdl-menu #chooseModulesMenu="mdlMenu" mdl-menu-position="bottom-left">
                <mdl-menu-item mdl-ripple *ngFor="let database of modulesDatabases" (click)="selectModulesDb(database)">{{database.name}}</mdl-menu-item>
              </mdl-menu>
            </div>
            <div *ngIf="modulesDb && modulesDb.id === '0'">
              <span>Modules Root: </span>
              <button mdl-button #chooseModulesRootButton="mdlButton" (click)="chooseModulesRootMenu.toggle($event, chooseModulesRootButton)" mdl-ripple>
                <span>{{currentModulesRoot()}}</span>
                <i class="fa fa-caret-down"></i>
              </button>
              <mdl-menu #chooseModulesRootMenu="mdlMenu" mdl-menu-position="bottom-left">
                <mdl-menu-item mdl-ripple *ngFor="let root of modulesRoots" (click)="selectModulesRoot(root)">{{root}}</mdl-menu-item>
              </mdl-menu>
            </div>
          </div>
          <div class="section-body">
            <app-file-browser
              [fileSets]="[serverFiles, systemFiles]"
              [selectedUri]="currentUri"
              (fileShown)="fileClicked($event.uri)"></app-file-browser>
          </div>
        </div>
        <gm-divider></gm-divider>
        <div gm-col class="flex flex-70">
          <div class="fill-height" *ngIf="fileText">
            <div class="section-title file-viewer">
              <template [ngIf]="currentUri">
                <span>File View: {{currentUri}}</span>
                <!-- <span title="Debug this file on the server" class="invoke-module clickable" (click)="invokeModule(currentUri)"><mdl-icon>play_arrow</mdl-icon></span> -->
                <button mdl-button #runOnServerButton="mdlButton" (click)="runOnServerMenu.toggle($event, runOnServerButton)" mdl-button-type="icon" mdl-ripple><mdl-icon>play_arrow</mdl-icon></button>
                <mdl-menu #runOnServerMenu="mdlMenu" mdl-menu-position="bottom-left">
                  <mdl-menu-item class="list-title">Choose an Appserver to run against</mdl-menu-item>
                  <mdl-menu-item *ngFor="let server of appServers" (click)="invokeModule(currentUri, server.id)">{{server.name}}</mdl-menu-item>
                </mdl-menu>
              </template>
            </div>
            <div class="section-body">
              <app-codemirror *ngIf="fileText"
                [ngModel]="fileText"
                [breakpoints]="fileBreakpoints"
                [config]="codeMirrorConfig"
                [line]="currentLine"
                [showLine]="showLine"
                [expression]="currentExpression"></app-codemirror>
            </div>
          </div>
        </div>
      </div>
      <div gm-divider class="debug-divider">
        <span>Debug Area</span>
      </div>
      <div gm-row class="flex flex-30 debug-area">
        <div gm-col class="flex flex-30 debugger">
          <div class="disabled" *ngIf="!currentRequest">
            <span>DEBUG A REQUEST TO ENABLE</span>
          </div>
          <div class="section-title">
            <!-- <span><mdl-icon>pause</mdl-icon></span> -->
            <span class="clickable" title="continue" (click)="continue()"><mdl-icon>play_arrow</mdl-icon></span>
            <span class="clickable" title="step over" (click)="stepOver()"><mdl-icon>redo</mdl-icon></span>
            <span class="clickable" title="step in" (click)="stepIn()"><mdl-icon>vertical_align_bottom</mdl-icon></span>
            <span class="clickable" title="step out" (click)="stepOut()"><mdl-icon>vertical_align_top</mdl-icon></span>
          </div>
          <div class="section-body">
            <app-subsection [title]="'Stack'">
              <ul *ngIf="hasFrames()" class="frames">
                <li *ngFor="let frame of stack.frames; let idx = index" [ngClass]="{'active' : idx === currentStackPosition}" (click)="showFile(frame, idx)">
                  <i class="fa fa-long-arrow-right" [ngClass]="{'visible': idx === currentStackPosition}"></i>
                  {{frame.uri}}:{{frame.line}}
                </li>
              </ul>
              <ul *ngIf="!hasFrames()" class="frames">
                <li>&nbsp;</li>
              </ul>
            </app-subsection>
            <app-subsection [title]="'Variables'">
              <ul *ngIf="hasVariables()" class="frames">
                <template [ngIf]="stack.frames[currentStackPosition] && stack.frames[currentStackPosition].externalVariables && stack.frames[currentStackPosition].externalVariables.length > 0">
                  <li class="subheading">External Variables</li>
                  <li *ngFor="let variable of stack.frames[currentStackPosition].externalVariables">{{variable.name}}: {{variable.value}}</li>
                </template>
                <template [ngIf]="stack.frames[currentStackPosition] && stack.frames[currentStackPosition].globalVariables && stack.frames[currentStackPosition].globalVariables.length > 0">
                  <li class="subheading">Global Variables</li>
                  <li *ngFor="let variable of stack.frames[currentStackPosition].globalVariables">{{variable.name}}: {{variable.value}}</li>
                </template>
                <template [ngIf]="stack.frames[currentStackPosition] && stack.frames[currentStackPosition].variables">
                  <li class="subheading">Local Variables</li>
                  <li *ngFor="let variable of stack.frames[currentStackPosition].variables">{{variable.name}}: {{variable.value}}</li>
                </template>
              </ul>
              <p *ngIf="!hasVariables()">&nbsp;</p>
            </app-subsection>
            <app-subsection [title]="'Console'" (clickHandler)="focusConsole($event)">
              <div class="console-buttons" section-header>
                <button md-button (click)="clearConsole($event)">Clear</button>
              </div>
              <div *ngFor="let output of consoleOutput" class="console-output">
                <span *ngIf="output.type === 'e'" class="error">Server Error <a (click)="showError(output.txt)">(show)</a></span>
                <span *ngIf="output.type !== 'e'">
                  <span class="prompt">{{output.type === 'i' ? '>' : '<-' }} </span><span>{{output.txt}}</span>
                </span>
              </div>
              <span class="prompt">&gt; </span><input #consoleInputCtrl class="console-input" type="text" [(ngModel)]="consoleInput" (keyup)="consoleKeyPressed($event)">
            </app-subsection>
          </div>
        </div>
        <div gm-divider></div>
        <div gm-col class="flex flex-35 breakpoints">
          <div class="section-title">BreakPoints</div>
          <div class="section-body">
            <p *ngIf="!breakpointUris || breakpointUris.length === 0">No breakpoints</p>
            <div *ngFor="let uri of breakpointUris">
              <ul>
                <li *ngFor="let breakpoint of breakpoints.get(uri)">
                  <span class="breakpoint-symbol" (click)="toggleBreakpoint(breakpoint)" [ngClass]="{ 'enabled' : breakpoint.enabled }">&#x25C9;</span>
                  <span (click)="gotoBreakpoint(breakpoint.uri, breakpoint.line)">{{breakpoint.uri}}:{{breakpoint.line + 1}}</span>
                  <i class="fa fa-times" (click)="disableBreakpoint(breakpoint)"></i>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div gm-divider></div>
        <div gm-col class="flex flex-35 requests">
          <div class="section-title">
            Requests <span class="clickable" (click)="getRequests()"><i class="fa fa-repeat"></i></span>
            <div class="debug-status">
              <span> Auto-pause requests ({{connectedServerCount()}}):</span>
              <button mdl-button #autoPauseButton="mdlButton" (click)="autoPauseMenu.toggle($event, autoPauseButton)" mdl-button-type="icon" mdl-ripple><mdl-icon>more_vert</mdl-icon></button>
              <mdl-menu #autoPauseMenu="mdlMenu" mdl-menu-position="top-right">
                <mdl-menu-item *ngFor="let server of appServers">
                  <mdl-switch [(ngModel)]="server.connected" (change)="toggleConnected(server)" mdl-ripple></mdl-switch>
                  <span> {{server.name}}</span>
                </mdl-menu-item>
              </mdl-menu>
            </div>
          </div>
          <div class="section-body">
            <p *ngIf="!requests || requests.length === 0">No Requests stopped</p>
            <ul *ngIf="requests && requests.length > 0">
              <li *ngFor="let request of requests" [ngClass]="{'expired' : request.isExpired}" [title]="getRequestName(request)" (click)="debugRequest(request)">
                <i class="fa fa-hourglass-o" *ngIf="request.isExpired"></i>
                <i class="fa fa-long-arrow-right" *ngIf="currentRequest && currentRequest.requestId === request.requestId"></i>
                {{getRequestName(request) | truncate:30}}
                <span *ngIf="request.isExpired" class="request-id">(Request Expired!)</span>
                <span *ngIf="!request.isExpired" class="request-id">({{request.requestId}})</span>
                <span *ngIf="request.debuggingStatus === 'attached'" class="clickable" title="continue" (click)="continueRequest(request.requestId, $event)"><mdl-icon>play_arrow</mdl-icon></span>
                <span *ngIf="request.debuggingStatus !== 'attached'" class="clickable" title="pause" (click)="pauseRequest(request.requestId, $event)"><mdl-icon>pause</mdl-icon></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </mdl-layout-content>
</mdl-layout>
